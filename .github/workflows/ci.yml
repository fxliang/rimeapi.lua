name: CI

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - '*'
    tags:
      - '![0-9]+.*'
    paths:
      - '**/**'
      - '!*.md'
      - '!.gitignore'
  pull_request:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        maker: [cmake, xmake]
    steps:

      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: install powershell and 7zip
        run: |
          brew install --cask powershell
          brew install p7zip

      - name: setup librime
        run: |
          pwsh ./get-rime.ps1 -use toy -tag latest
          cp -r lib/* .

      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'
        with:
          actions-cache-folder: '.xmake-cache'

      - name: build rimeapi.lua
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: |
          xmake f -y -p macosx --includedirs=dist/include
          xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: install luajit
        run: |
          brew install luajit
          luajit -v

      - name: test
        run: |
          ./rimeapi.app.lua test.lua api_test levers_api_test
          ./lua test.lua api_test levers_api_test
          luajit test.lua api_test levers_api_test
          ./lua ./rimeapi.app.lua test.lua api_test levers_api_test
          luajit ./rimeapi.app.lua test.lua api_test levers_api_test

      - name: prepare artifact
        if: matrix.maker == 'xmake'
        run: |
          mkdir -p dist
          cp ./rimeapi_lua.dylib ./dist/
          cp ./rimeapi.lua ./dist/
          cp ./rimeapi_ffi.lua ./dist/
          cp ./rimeapi.app.lua ./dist/
          cp ./test.lua ./dist/
          cp -r ./scripts ./dist/
          cp -r ./shared ./dist/
          cp ./rimeapi.annotation.lua ./dist/
          cp ./README.md ./dist/
          cp ./rime_api_console.lua ./dist/
          cp ./librime.*.dylib ./dist/
          cp -r ./rime-plugins ./dist/

      - name: upload artifact
        if: matrix.maker == 'xmake'
        uses: actions/upload-artifact@v5
        with:
          name: rimeapi.lua-macos-dist
          path: ./dist/

  build-ubuntu:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        maker: [cmake, xmake]
    steps:

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: compute librime short hash
        id: librime-hash
        run: |
          pushd librime
          short=$(git rev-parse --short HEAD)
          echo "short=$short" >> "$GITHUB_OUTPUT"
          popd

      - name: cache librime build
        id: cache-librime
        uses: actions/cache@v4
        with:
          path: librime/librime_1.14.0-1_amd64.deb
          key: ${{ runner.os }}-librime-${{ steps.librime-hash.outputs.short }}
          restore-keys: |
            ${{ runner.os }}-librime-

      - name: setup deps
        working-directory: librime
        run: ./action-install-linux.sh

      - name: prepare librime
        id: prepare-librime
        if: steps.cache-librime.outputs.cache-hit != 'true'
        working-directory: librime
        env:
          CMAKE_GENERATOR: Ninja
        run: |
          sudo apt install -y checkinstall
          make
          sudo checkinstall \
            --pkgname=librime \
            --pkgversion=1.14.0 \
            --pkgrelease=1 \
            --arch=amd64 \
            --pkglicense=BSD \
            --maintainer="fx.liang@outlook.com" \
            --requires="libc6, libgcc-s1, libstdc++6, libgflags2.2, libgoogle-glog0v6t64, libleveldb1d, libmarisa0, libopencc1.1, libsnappy1v5, libunwind8" \
            --nodoc \
            --install=no \
            --default \
            --backup=no

      - name: install librime
        if: steps.cache-librime.outputs.cache-hit == 'true' || steps.prepare-librime.outcome == 'success'
        working-directory: librime
        run: sudo apt install -y ./librime_1.14.0-1_amd64.deb

      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'
        with:
          actions-cache-folder: '.xmake-cache'

      - name: build rimeapi.lua
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        shell: bash
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: install luajit
        run: |
          sudo apt install -y luajit
          luajit -v

      - name: test
        run: |
          ./rimeapi.app.lua test.lua api_test levers_api_test
          ./lua test.lua api_test levers_api_test
          luajit test.lua api_test levers_api_test
          ./lua ./rimeapi.app.lua test.lua api_test levers_api_test
          luajit ./rimeapi.app.lua test.lua api_test levers_api_test

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        maker: [cmake, xmake]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Copy Rime files
        shell: pwsh
        run: |
          .\get-rime.ps1 -use toy -tag latest

      - name: Build rimeapi.lua with xmake
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: |
          xmake f -a ${{ matrix.arch }} -y && xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        shell: pwsh
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: install luajit
        shell: pwsh
        run: |
          git clone -v --depth=1 https://github.com/LuaJIT/LuaJIT
          pushd .\LuaJIT\src
          .\msvcbuild.bat
          popd

      - name: run tests
        shell: cmd
        env:
          PATH: .\LuaJIT\src\;${{ env.PATH }}
        run: |
          .\lua.exe test.lua api_test levers_api_test
          luajit.exe test.lua api_test levers_api_test
          luajit.exe .\rimeapi.app.lua test.lua api_test levers_api_test
          .\lua.exe .\rimeapi.app.lua test.lua api_test levers_api_test

      - name: prepare artifact
        if: matrix.maker == 'xmake'
        run: |
          mkdir dist
          cp ./rimeapi_lua.dll ./dist/
          cp ./rimeapi.lua ./dist/
          cp ./rimeapi_ffi.lua ./dist/
          cp ./rimeapi.app.lua ./dist/
          cp ./test.lua ./dist/
          cp -r ./scripts ./dist/
          cp -r ./shared ./dist/
          cp ./rimeapi.annotation.lua ./dist/
          cp ./README.md ./dist/
          cp ./rime_api_console.lua ./dist/
          cp ./rime.dll ./dist/

      - name: upload artifact
        if: matrix.maker == 'xmake'
        uses: actions/upload-artifact@v5
        with:
          name: rimeapi.lua-win${{ matrix.arch }}-dist
          path: ./dist/

  latest-release:
    runs-on: ubuntu-latest
    needs: [build-macos, build-windows]
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-macos-dist
          path: ./artifacts/rimeapi.lua-macos-dist

      - name: Download Windows x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-winx64-dist
          path: ./artifacts/rimeapi.lua-winx64-dist

      - name: Download Windows x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-winx86-dist
          path: ./artifacts/rimeapi.lua-winx86-dist

      - name: Compress zips
        run: |
          cd ./artifacts
          zip -r rimeapi.lua-macos-dist.zip rimeapi.lua-macos-dist
          zip -r rimeapi.lua-winx64-dist.zip rimeapi.lua-winx64-dist
          zip -r rimeapi.lua-winx86-dist.zip rimeapi.lua-winx86-dist

      - name: Create latest release
        if: ${{ github.repository == 'fxliang/rimeapi.lua' && github.ref == 'refs/heads/master' }}
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: latest
          prerelease: true
          title: "Nightly Build"
          files: |
            ./artifacts/rimeapi.lua-macos-dist.zip
            ./artifacts/rimeapi.lua-winx64-dist.zip
            ./artifacts/rimeapi.lua-winx86-dist.zip
