name: CI

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches:
      - '*'
    tags:
      - '![0-9]+.*'
    paths:
      - '**/**'
      - '!*.md'
      - '!.gitignore'
  pull_request:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        maker: [xmake]
    steps:

      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: setup librime
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pwsh ./get-rime.ps1 -use toy -tag latest
          cp -r lib/* .

      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'
        with:
          actions-cache-folder: '.xmake-cache'

      - name: build rimeapi.lua
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: |
          xmake f -y -p macosx --includedirs=dist/include
          xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: install luajit
        run: |
          brew install luajit
          luajit -v

      - name: test
        run: |
          ./rimeapi.app.lua test.lua api_test levers_api_test
          ./lua test.lua api_test levers_api_test
          luajit test.lua api_test levers_api_test
          ./lua ./rimeapi.app.lua test.lua api_test levers_api_test
          luajit ./rimeapi.app.lua test.lua api_test levers_api_test

      - name: prepare artifact
        if: matrix.maker == 'xmake'
        run: |
          mkdir -p dist
          cp ./rimeapi_lua.dylib ./dist/
          cp ./rimeapi.lua ./dist/
          cp ./rimeapi_ffi.lua ./dist/
          cp ./rimeapi.app.lua ./dist/
          cp ./test.lua ./dist/
          cp -r ./scripts ./dist/
          cp -r ./shared ./dist/
          cp ./rimeapi.annotation.lua ./dist/
          cp ./README.md ./dist/
          cp ./rime_api_console.lua ./dist/
          cp ./librime.dylib ./dist/
          cp -r ./rime-plugins ./dist/
          cp ./LICENSE ./dist/
          cp ./schema_tester.lua ./dist/
          cp ./schema_tester_config.lua ./dist/
          cp ./noti_bridge.dylib ./dist/

      - name: upload artifact
        if: matrix.maker == 'xmake'
        uses: actions/upload-artifact@v5
        with:
          name: rimeapi.lua-macos-dist
          path: ./dist/

  build-ubuntu:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        maker: [xmake]

    steps:

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: compute librime short hash
        id: librime-hash
        run: |
          pushd librime
          short=$(git rev-parse --short HEAD)
          echo "short=$short" >> "$GITHUB_OUTPUT"
          popd

      - name: cache librime build
        id: cache-librime
        uses: actions/cache@v4
        with:
          path: librime.so
          key: ${{ runner.os }}-librime-${{ steps.librime-hash.outputs.short }}
          restore-keys: |
            ${{ runner.os }}-librime-

      - name: setup deps
        working-directory: librime
        if: steps.cache-librime.outputs.cache-hit != 'true'
        run: ./action-install-linux.sh

      - name: prepare librime
        id: prepare-librime
        if: steps.cache-librime.outputs.cache-hit != 'true'
        working-directory: librime
        env:
          CMAKE_GENERATOR: Ninja
          RIME_PLUGINS: hchunhui/librime-lua lotem/librime-octagram rime/librime-predict
        run: |
          ./action-install-plugins-macos.sh
          cp ../action.patch ./
          git apply action.patch
          make deps
          make merged-plugins
          cp build/lib/librime.so ../
          ldd ../librime.so

      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'
        with:
          actions-cache-folder: '.xmake-cache'

      - name: build rimeapi.lua
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        shell: bash
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: install luajit
        run: |
          sudo apt install -y luajit
          luajit -v

      - name: test
        run: |
          ./rimeapi.app.lua test.lua api_test levers_api_test
          ./lua test.lua api_test levers_api_test
          luajit test.lua api_test levers_api_test
          ./lua ./rimeapi.app.lua test.lua api_test levers_api_test
          luajit ./rimeapi.app.lua test.lua api_test levers_api_test

      - name: prepare artifact
        if: matrix.maker == 'xmake'
        run: |
          mkdir -p dist
          cp ./rimeapi_lua.so ./dist/
          cp ./rimeapi.lua ./dist/
          cp ./rimeapi_ffi.lua ./dist/
          cp ./rimeapi.app.lua ./dist/
          cp ./test.lua ./dist/
          cp -r ./scripts ./dist/
          cp -r ./shared ./dist/
          cp ./rimeapi.annotation.lua ./dist/
          cp ./README.md ./dist/
          cp ./rime_api_console.lua ./dist/
          cp ./LICENSE ./dist/
          cp ./schema_tester.lua ./dist/
          cp ./schema_tester_config.lua ./dist/
          cp ./noti_bridge.so ./dist/
          cp ./librime.so ./dist/

      - name: upload artifact
        if: matrix.maker == 'xmake'
        uses: actions/upload-artifact@v5
        with:
          name: rimeapi.lua-ubuntu24.04-dist
          path: ./dist/

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        maker: [xmake]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: xmake-io/github-action-setup-xmake@v1
        if: matrix.maker == 'xmake'

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: cache librime
        id: cache-librime
        uses: actions/cache@v4
        with:
          path: |
            include
            lib
            lib64
            shared/opencc
          key: ${{ runner.os }}-librime-latest-${{ matrix.arch }}
          restore-keys: |
            ${{ runner.os }}-librime-latest-{{ matrix.arch }}

      - name: Copy Rime files
        if: steps.cache-librime.outputs.cache-hit != 'true'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          .\get-rime.ps1 -use toy -tag latest

      - name: Build rimeapi.lua with xmake
        if: matrix.maker == 'xmake'
        id: build_rimeapi_lua_xmake
        run: |
          xmake f -a ${{ matrix.arch }} -y && xmake -y

      - name: Build rimeapi.lua with cmake
        if: matrix.maker == 'cmake'
        shell: pwsh
        id: build_rimeapi_lua_cmake
        run: |
          cmake -Bbuild .
          cmake --build build --config Release
          cmake --install build --prefix . --config Release

      - name: cache luajit
        id: cache-luajit
        uses: actions/cache@v4
        with:
          path: LuaJIT
          key: ${{ runner.os }}-luajit-${{ matrix.arch }} 
          restore-keys: |
            ${{ runner.os }}-luajit-${{ matrix.arch }}
            
      - name: install luajit
        if: steps.cache-luajit.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          git clone -v --depth=1 https://github.com/LuaJIT/LuaJIT
          pushd .\LuaJIT\src
          .\msvcbuild.bat
          popd

      - name: run tests
        shell: cmd
        env:
          PATH: .\LuaJIT\src\;${{ env.PATH }}
        run: |
          .\lua.exe test.lua api_test levers_api_test
          luajit.exe test.lua api_test levers_api_test
          luajit.exe .\rimeapi.app.lua test.lua api_test levers_api_test
          .\lua.exe .\rimeapi.app.lua test.lua api_test levers_api_test

      - name: prepare artifact
        if: matrix.maker == 'xmake'
        run: |
          mkdir dist
          cp ./rimeapi_lua.dll ./dist/
          cp ./rimeapi.lua ./dist/
          cp ./rimeapi_ffi.lua ./dist/
          cp ./rimeapi.app.lua ./dist/
          cp ./test.lua ./dist/
          cp -r ./scripts ./dist/
          cp -r ./shared ./dist/
          cp ./rimeapi.annotation.lua ./dist/
          cp ./README.md ./dist/
          cp ./rime_api_console.lua ./dist/
          cp ./rime.dll ./dist/
          cp ./LICENSE ./dist/
          cp ./schema_tester.lua ./dist/
          cp ./schema_tester_config.lua ./dist/
          cp ./noti_bridge.dll ./dist/

      - name: upload artifact
        if: matrix.maker == 'xmake'
        uses: actions/upload-artifact@v5
        with:
          name: rimeapi.lua-win${{ matrix.arch }}-dist
          path: ./dist/

  latest-release:
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-24.04
    needs: [build-macos, build-windows, build-ubuntu]
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-macos-dist
          path: ./artifacts/rimeapi.lua-macos-dist

      - name: Download Windows x64 artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-winx64-dist
          path: ./artifacts/rimeapi.lua-winx64-dist

      - name: Download Windows x86 artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-winx86-dist
          path: ./artifacts/rimeapi.lua-winx86-dist

      - name: Download Ubuntu 24.04 artifact
        uses: actions/download-artifact@v4
        with:
          name: rimeapi.lua-ubuntu24.04-dist
          path: ./artifacts/rimeapi.lua-ubuntu24.04-dist

      - name: Compress zips
        run: |
          cd ./artifacts
          zip -r rimeapi.lua-macos-dist.zip rimeapi.lua-macos-dist
          zip -r rimeapi.lua-winx64-dist.zip rimeapi.lua-winx64-dist
          zip -r rimeapi.lua-winx86-dist.zip rimeapi.lua-winx86-dist
          zip -r rimeapi.lua-ubuntu24.04-dist.zip rimeapi.lua-ubuntu24.04-dist

      - name: Create latest release
        if: ${{ github.repository == 'fxliang/rimeapi.lua' && github.ref == 'refs/heads/master' }}
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: latest
          prerelease: true
          title: "Latest Build"
          files: |
            ./artifacts/rimeapi.lua-macos-dist.zip
            ./artifacts/rimeapi.lua-winx64-dist.zip
            ./artifacts/rimeapi.lua-winx86-dist.zip
            ./artifacts/rimeapi.lua-ubuntu24.04-dist.zip
